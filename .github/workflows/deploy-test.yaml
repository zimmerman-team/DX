name: Deploy to Test with Self-Hosted Runner

on:
  push:
    branches:
      - develop # Trigger on push to the main branch
  workflow_dispatch: # Allow manual triggering

jobs:
  deploy:
    runs-on: self-hosted # Use the self-hosted runner

    steps:
      - name: Pull latest changes
        run: |
          cd ~/DX
          git fetch origin
          git checkout develop  
          git pull origin develop --rebase

      - name: Pull Dx.Client
        run: |
          cd ~/DX
          cd dx.client
          git checkout develop
          git pull origin develop
          cd ..

      - name: Pull Dx.Server
        run: |
          cd ~/DX
          cd dx.server
          git checkout develop
          git pull origin develop
          cd ..

      - name: Pull Dx.backend
        run: |
          cd ~/DX
          cd dx.backend
          git checkout main
          git pull origin main
          cd ..

      - name: Pull Rawgraphs
        run: |
          cd ~/DX
          cd rawgraphs-charts
          git checkout feat/DX-137
          git pull origin feat/DX-137
          cd ..

      - name: Pull General AI API
        run: |
          cd ~/DX
          cd general-ai-api
          git checkout main
          git pull origin main
          cd ..

      - name: Run deployment script
        run: |
          cd ~/DX
          bash -c "yes || true" | sudo bash scripts/redeploy.sh test

  update-client:
    runs-on: self-hosted

    needs:
      - deploy

    steps:
      - name: Run copy script
        run: |
          cd ~/DX
          sleep 3 # wait for the frontend to be mounted
          sudo rm -rf /var/www/html/test/build/ && sudo cp -r ~/DX/dx.client/test/build/ /var/www/html/test/
